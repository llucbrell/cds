{% block content %}
<div class="row">
    <div class="col-md-12 text-center my-4">
        <h1>Administrador de datos</h1>
    </div>
    <div class="col-md-12">
        <div class="accordion" id="dataAdminAccordion">
            <div class="card">
                <div class="card-header" id="fixedHeading">
                    <h2 class="mb-0">
                        <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#fixedCollapse" aria-expanded="true" aria-controls="fixedCollapse">
                            Ítems Fijos
                        </button>
                    </h2>
                </div>
                <div id="fixedCollapse" class="collapse show" aria-labelledby="fixedHeading" data-parent="#dataAdminAccordion">
                    <div class="card-body">
                        <h4>Crear Ítem Fijo</h4>
                        <form id="fixed-form">
                            <div class="form-group">
                                <input id="fixed-key" name="key" placeholder="Clave" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <input id="fixed-value" name="value" placeholder="Valor" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <input type="hidden" name="value_type" value="fixed">
                            </div>
                            <button type="submit" class="btn btn-primary mt-2">Agregar Ítem Fijo</button>
                        </form>
                        <button id="reload-fixed" class="btn btn-secondary mt-2">Cargar Ítems Fijos</button>
                        <div id="fixed-output" class="mt-3"></div>
                        <div id="fixed-items" class="mt-3">
                            <h4>Valores Existentes</h4>
                            <ul class="list-group" id="fixed-items-list">
                                <!-- Lista de ítems fijos se llenará dinámicamente -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header" id="iterableHeading">
                    <h2 class="mb-0">
                        <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#iterableCollapse" aria-expanded="false" aria-controls="iterableCollapse">
                            Ítems Iterables
                        </button>
                    </h2>
                </div>
                <div id="iterableCollapse" class="collapse" aria-labelledby="iterableHeading" data-parent="#dataAdminAccordion">
                    <div class="card-body">
                        <h4>Crear Ítem Iterable</h4>
                        <input type="file" id="upload-iterable" class="form-control">
                        <input id="iterable-range" placeholder="Rango (ej. A-C)" class="form-control">
                        <button id="add-iterable" class="btn btn-primary mt-2">Agregar Ítem Iterable</button>
                        <div id="iterable-output" class="mt-3"></div>
                        <div id="iterable-items" class="mt-3">
                            <h4>Valores Iterables Existentes</h4>
                            <ul class="list-group" id="iterable-items-list">
                                <!-- Lista de ítems iterables se llenará dinámicamente -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header" id="arrayHeading">
                    <h2 class="mb-0">
                        <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#arrayCollapse" aria-expanded="false" aria-controls="arrayCollapse">
                            Ítems Arrays
                        </button>
                    </h2>
                </div>
                <div id="arrayCollapse" class="collapse" aria-labelledby="arrayHeading" data-parent="#dataAdminAccordion">
                    <div class="card-body">
                        <h4>Crear Ítem Array</h4>
                        <input type="file" id="upload-array" class="form-control">
                        <button id="add-array" class="btn btn-primary mt-2">Agregar Ítem Array</button>
                        <div id="array-output" class="mt-3"></div>
                        <div id="array-items" class="mt-3">
                            <h4>Valores Arrays Existentes</h4>
                            <ul class="list-group" id="array-items-list">
                                <!-- Lista de ítems arrays se llenará dinámicamente -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        function getIdsFromUrl() {
            const pathArray = window.location.pathname.split('/');
            const testId = pathArray[pathArray.length - 1];
            const collectionId = pathArray[pathArray.length - 2];
            return { testId, collectionId };
        }

        const { testId, collectionId } = getIdsFromUrl();
        console.log(`testId: ${testId}, collectionId: ${collectionId}`);  // Logging IDs

        function saveData(endpoint, data, outputId, callback) {
            console.log(`Sending data to ${endpoint}:`, data);  // Logging request data
            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                console.log(`Response from ${endpoint}:`, data);  // Logging response data
                document.getElementById(outputId).innerText = data.message;
                document.getElementById(outputId).className = data.status === 'success' ? 'text-success' : 'text-danger';
                if (callback) {
                    callback(data.values);
                }
                setTimeout(() => {
                    document.getElementById(outputId).innerText = '';
                    document.getElementById(outputId).className = '';
                }, 5000);  // Clear message after 5 seconds
            })
            .catch(error => console.error('Error:', error));  // Logging errors
        }

        function updateValuesList(values, listId) {
            const listElement = document.getElementById(listId);
            listElement.innerHTML = '';
            values.forEach(value => {
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item';
                listItem.innerHTML = `
                    <strong>${value.value_key}</strong>: ${value.value_value}
                    <button class="btn btn-secondary btn-sm edit-btn" data-id="${value.id}">Editar</button>
                    <button class="btn btn-danger btn-sm delete-btn" data-id="${value.id}">Eliminar</button>
                `;
                listElement.appendChild(listItem);
            });
        }

        function loadValues() {
            const endpoint = `/values/${testId}`;
            fetch(endpoint, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log(`Loaded values:`, data);  // Logging loaded values
                updateValuesList(data.values, 'fixed-items-list');
                updateValuesList(data.values, 'iterable-items-list');
                updateValuesList(data.values, 'array-items-list');
            })
            .catch(error => console.error('Error:', error));  // Logging errors
        }

        document.getElementById('fixed-form').addEventListener('submit', function (event) {
            event.preventDefault();
            const key = document.getElementById('fixed-key').value;
            const value = document.getElementById('fixed-value').value;
            const endpoint = `/values/${testId}`;
            saveData(endpoint, { key, value, value_type: 'fixed' }, 'fixed-output', function(values) {
                updateValuesList(values, 'fixed-items-list');
            });
        });

        document.getElementById('add-iterable').addEventListener('click', function () {
            const range = document.getElementById('iterable-range').value;
            const fileInput = document.getElementById('upload-iterable');
            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function (event) {
                const csvData = event.target.result;
                const endpoint = `/values/${testId}`;
                saveData(endpoint, { range, csvData, value_type: 'iterable' }, 'iterable-output', function(values) {
                    updateValuesList(values, 'iterable-items-list');
                });
            };

            reader.readAsText(file);
        });

        document.getElementById('add-array').addEventListener('click', function () {
            const fileInput = document.getElementById('upload-array');
            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function (event) {
                const csvData = event.target.result;
                const endpoint = `/values/${testId}`;
                saveData(endpoint, { csvData, value_type: 'array' }, 'array-output', function(values) {
                    updateValuesList(values, 'array-items-list');
                });
            };

            reader.readAsText(file);
        });

        document.getElementById('reload-fixed').addEventListener('click', function () {
            loadValues();
        });

        document.addEventListener('click', function (event) {
            if (event.target.classList.contains('delete-btn')) {
                const valueId = event.target.getAttribute('data-id');
                const endpoint = `/values/delete/${valueId}`;
                fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    console.log(`Response from ${endpoint}:`, data);
                    updateValuesList(data.values, 'fixed-items-list');
                    updateValuesList(data.values, 'iterable-items-list');
                    updateValuesList(data.values, 'array-items-list');
                })
                .catch(error => console.error('Error:', error));
            }

            if (event.target.classList.contains('edit-btn')) {
                const valueId = event.target.getAttribute('data-id');
                // Implement your edit functionality here
                console.log(`Edit value with ID: ${valueId}`);
            }
        });

        // Load initial values when the page loads
        loadValues();
    });
</script>
{% endblock %}
