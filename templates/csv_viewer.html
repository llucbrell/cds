{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-12 text-center my-4">
            <h1>Visor de CSV</h1>
        </div>
        <div class="col-md-12">
            <form id="csv-form" enctype="multipart/form-data">
                <div class="form-group">
                    <input type="file" id="csv-file" name="csv_file" class="form-control" accept=".csv" required>
                </div>
                <button type="submit" class="btn btn-primary mt-2">Cargar CSV</button>
            </form>
            <div id="csv-output" class="mt-3"></div>
            <div id="csv-table" class="mt-3" style="width: 100%; height: 600px;"></div>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-md-12">
            <h4>Seleccionar Rango</h4>
            <form id="range-form">
                <div class="form-group">
                    <label for="range-start">Inicio:</label>
                    <input type="text" id="range-start" name="range_start" class="form-control" placeholder="Ej: A1">
                </div>
                <div class="form-group">
                    <label for="range-end">Fin:</label>
                    <input type="text" id="range-end" name="range_end" class="form-control" placeholder="Ej: C10">
                </div>
                <button type="submit" class="btn btn-primary mt-2">Actualizar Rango</button>
            </form>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const container = document.getElementById('csv-table');
        let hot;

        document.getElementById('csv-form').addEventListener('submit', function (event) {
            event.preventDefault();
            const formData = new FormData();
            const fileInput = document.getElementById('csv-file');
            const file = fileInput.files[0];
            formData.append('csv_file', file);

            fetch('/upload_csv', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    displayTable(data.csv_data);
                } else {
                    document.getElementById('csv-output').innerText = data.message;
                    document.getElementById('csv-output').className = 'text-danger';
                }
            })
            .catch(error => console.error('Error:', error));
        });

        document.getElementById('range-form').addEventListener('submit', function (event) {
            event.preventDefault();
            const rangeStart = document.getElementById('range-start').value;
            const rangeEnd = document.getElementById('range-end').value;

            fetch('/update_range', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ range_start: rangeStart, range_end: rangeEnd })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    displayTable(data.csv_data);
                } else {
                    document.getElementById('csv-output').innerText = data.message;
                    document.getElementById('csv-output').className = 'text-danger';
                }
            })
            .catch(error => console.error('Error:', error));
        });

        function displayTable(csvData) {
            const data = csvData.split('\n').map(row => row.split(','));

            if (hot) {
                hot.destroy();
            }

            hot = new Handsontable(container, {
                data: data,
                rowHeaders: true,
                colHeaders: true,
                contextMenu: true,
                filters: true,
                dropdownMenu: true,
                licenseKey: 'non-commercial-and-evaluation'
            });
        }

        function loadValues() {
            const rangeForm = document.getElementById('range-form');
            rangeForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const rangeStart = document.getElementById('range-start').value;
                const rangeEnd = document.getElementById('range-end').value;

                const startCell = Handsontable.helper.cellReferenceToIndex(rangeStart);
                const endCell = Handsontable.helper.cellReferenceToIndex(rangeEnd);

                const selectedData = [];
                for (let row = startCell.row; row <= endCell.row; row++) {
                    const rowData = [];
                    for (let col = startCell.col; col <= endCell.col; col++) {
                        rowData.push(hot.getDataAtCell(row, col));
                    }
                    selectedData.push(rowData);
                }

                displayTable(selectedData.map(row => row.join(',')).join('\n'));
            });
        }

        // Load initial values when the page loads
        loadValues();
    });
</script>
{% endblock %}
