{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-12 text-center my-4">
            <h1>CSV Viewer</h1>
        </div>
        <div class="col-md-12">
            <form id="csv-form" enctype="multipart/form-data">
                <div class="form-group">
                    <input type="file" id="csv-file" name="csv_file" class="form-control" accept=".csv,.xlsx" required>
                </div>
                <!-- Spinner -->
                <div id="spinner" class="mt-3 text-center" style="display: none;">
                    <i class="fas fa-spinner fa-spin fa-3x"></i>
                </div>
                <button type="submit" class="btn btn-outline-primary mt-2" title="Confirm" style="float: right;">
                    <i class="fas fa-file-upload"></i>
                </button>
            </form>
            <div id="csv-output" class="mt-3"></div>
            <div id="csv-table" class="mt-3" style="width: 100%; height: 600px; overflow: auto;"></div>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-md-12">
            <div id="selected-range" class="alert alert-info" role="alert">
                No range selected
            </div>
            <br>
            <input id="array-key" name="key" placeholder="Name" class="form-control" required>
            <button id="save-selection" class="btn btn-outline-success mt-4" title="Guardar">
                <i class="fa-solid fa-floppy-disk"></i>
            </button>
            <button id="invert-selection" class="btn btn-outline-warning mt-4" title="Invertir SelecciÃ³n">
                <i class="fas fa-arrows-rotate"></i>
            </button>
            <!-- Spinner -->
            <div id="spinner-save" class="mt-3 text-center" style="display: none;">
                <i class="fas fa-spinner fa-spin fa-3x"></i>
            </div>
 
            <br>
            <br>
        </div>
    </div>
</div>
<link href="{{ url_for('static', filename='css/handsometable.good.full.min.css') }}" rel="stylesheet">
<script src="{{ url_for('static', filename='js/handsometable.full.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/xlsx.full.min.js') }}"></script>
<!-- Incluir PapaParse desde un CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const container = document.querySelector('#csv-table');
        let hot;
        let selectedData = [];

        // Initialize an empty Handsontable instance
        hot = new Handsontable(container, {
            data: [],
            rowHeaders: true,
            colHeaders: true,
            contextMenu: true,
            filters: true,
            dropdownMenu: true,
            height: 'auto',
            autoWrapRow: true,
            autoWrapCol: true,
            licenseKey: 'non-commercial-and-evaluation' // for non-commercial use only
        });

        document.querySelector('#csv-form').addEventListener('submit', function (event) {
            event.preventDefault();
            const fileInput = document.querySelector('#csv-file');
            if (!fileInput) {
                console.error("File input element not found.");
                return;
            }
            const file = fileInput.files[0];
            if (!file) {
                console.error("No file selected.");
                return;
            }

            showSpinner();
            const reader = new FileReader();

            reader.onload = function (event) {
                console.log("File read successfully.");
                if (file.name.endsWith(".csv")) {
                    Papa.parse(event.target.result, {
                        complete: function(results) {
                            hideSpinner();
                            displayTable(results.data);
                        },
                        header: false
                    });
                } else {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    displayTable(jsonData);
                }
            };

            // Determinar el tipo de archivo y leerlo adecuadamente
            if (file.name.endsWith(".csv")) {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        });

        function showSpinnerSave() {
        const spinner = document.querySelector('#spinner-save');
        if (spinner) {
                spinner.style.display = 'block';
            }
        }

        function hideSpinnerSave() {
            const spinner = document.querySelector('#spinner-save');
            if (spinner) {
                spinner.style.display = 'none';
            }
        }
        function showSpinner() {
        const spinner = document.querySelector('#spinner');
        if (spinner) {
                spinner.style.display = 'block';
            }
        }

        function hideSpinner() {
            const spinner = document.querySelector('#spinner');
            if (spinner) {
                spinner.style.display = 'none';
            }
        }
 
        function displayTable(data) {
            console.log("Displaying table with data:", data);

            hot.updateSettings({
                data: data,
                stretchH: 'all',
                width: '100%',
                height: 600,
                rowHeaders: true,
                colHeaders: true,
                contextMenu: true,
                filters: true,
                dropdownMenu: true,
            });

            // Add event listener for save-selection button after data is displayed
            document.querySelector('#save-selection').addEventListener('click', function () {
                console.log("Save selection button clicked.");
                if (!selectedData || selectedData.length === 0) {
                    console.error("No range selected!");
                    alert("No range selected!");
                    return;
                }

                try {
                   var arrayKey = document.getElementById("array-key"); 
                   console.log(arrayKey.value);
                } catch (error) {
                    alert("Can't save without name");
                    return;
                }

                console.log("Data to save:", selectedData);
                showSpinnerSave();
                
                const pathArray = window.location.pathname.split('/');
                const testId = pathArray[pathArray.length - 1];
                
                console.log(testId);
                const confirmMessage = `Are you sure you want to save the following data?\n\n${JSON.stringify(selectedData, null, 2)}`;
                if (confirm(confirmMessage)) {
                    fetch('/save_selection', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ value_key: arrayKey.value, value_value: selectedData, test_id: testId })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert('Data saved successfully!');
                            arrayKey.value = "";
                            location.reload();
                        } else {
                            alert('Error saving data: ' + data.message);
                            hideSpinnerSave();
                        }
                    })
                    .catch(error => console.error('Error:', error));
                }
            });

            // Add event listener for invert-selection button
            document.querySelector('#invert-selection').addEventListener('click', function () {
                console.log("Invert selection button clicked.");
                selectedData.reverse();
                console.log("Inverted data:", selectedData);
            });

            // Add listener to update selected range display
            hot.addHook('afterSelection', function (startRow, startCol, endRow, endCol) {
                const rangeDisplay = `Selected range: ${Handsontable.helper.spreadsheetColumnLabel(startCol)}${startRow + 1} to ${Handsontable.helper.spreadsheetColumnLabel(endCol)}${endRow + 1}`;
                document.querySelector('#selected-range').textContent = rangeDisplay;

                selectedData = [];
                for (let row = startRow; row <= endRow; row++) {
                    for (let col = startCol; col <= endCol; col++) {
                        selectedData.push(hot.getDataAtCell(row, col));
                    }
                }
                console.log("Selected data:", selectedData);
            });
        }
    });
</script>
{% endblock %}
