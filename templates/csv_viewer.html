{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-12 text-center my-4">
            <h1>Visor de CSV</h1>
        </div>
        <div class="col-md-12">
            <form id="csv-form" enctype="multipart/form-data">
                <div class="form-group">
                    <input type="file" id="csv-file" name="csv_file" class="form-control" accept=".csv,.xlsx" required>
                </div>
                <button type="submit" class="btn btn-primary mt-2">Cargar CSV</button>
            </form>
            <div id="csv-output" class="mt-3"></div>
            <div id="csv-table" class="mt-3" style="width: 100%; height: 600px; overflow: auto;"></div>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-md-12">
            <div id="selected-range" class="alert alert-info" role="alert">
                No range selected
            </div>
            <button id="save-selection" class="btn btn-success mt-4">Guardar Selección</button>
            <button id="invert-selection" class="btn btn-warning mt-4">Invertir Selección</button>
        </div>
    </div>
</div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" />
<script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const container = document.querySelector('#csv-table');
        let hot;
        let selectedData = [];

        // Initialize an empty Handsontable instance
        hot = new Handsontable(container, {
            data: [],
            rowHeaders: true,
            colHeaders: true,
            contextMenu: true,
            filters: true,
            dropdownMenu: true,
            height: 'auto',
            autoWrapRow: true,
            autoWrapCol: true,
            licenseKey: 'non-commercial-and-evaluation' // for non-commercial use only
        });

        document.querySelector('#csv-form').addEventListener('submit', function (event) {
            event.preventDefault();
            const fileInput = document.querySelector('#csv-file');
            if (!fileInput) {
                console.error("File input element not found.");
                return;
            }
            const file = fileInput.files[0];
            if (!file) {
                console.error("No file selected.");
                return;
            }
            const reader = new FileReader();

            reader.onload = function (event) {
                console.log("File read successfully.");
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const csvData = XLSX.utils.sheet_to_csv(worksheet);
                displayTable(csvData);
            };

            reader.readAsArrayBuffer(file);
        });

        function displayTable(csvData) {
            console.log("Displaying table with data:", csvData);
            const data = csvData.split('\n').map(row => row.split(','));

            hot.updateSettings({
                data: data
            });

            // Add event listener for save-selection button after data is displayed
            document.querySelector('#save-selection').addEventListener('click', function () {
                console.log("Save selection button clicked.");
                if (!selectedData || selectedData.length === 0) {
                    console.error("No range selected!");
                    alert("No range selected!");
                    return;
                }

                console.log("Data to save:", selectedData);
                
                const confirmMessage = `Are you sure you want to save the following data?\n\n${JSON.stringify(selectedData, null, 2)}`;
                if (confirm(confirmMessage)) {
                    fetch('/save_selection', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ selected_data: selectedData })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert('Data saved successfully!');
                        } else {
                            alert('Error saving data: ' + data.message);
                        }
                    })
                    .catch(error => console.error('Error:', error));
                }
            });

            // Add event listener for invert-selection button
            document.querySelector('#invert-selection').addEventListener('click', function () {
                console.log("Invert selection button clicked.");
                selectedData.reverse();
                console.log("Inverted data:", selectedData);
            });

            // Add listener to update selected range display
            hot.addHook('afterSelection', function (startRow, startCol, endRow, endCol) {
                const rangeDisplay = `Selected range: ${Handsontable.helper.spreadsheetColumnLabel(startCol)}${startRow + 1} to ${Handsontable.helper.spreadsheetColumnLabel(endCol)}${endRow + 1}`;
                document.querySelector('#selected-range').textContent = rangeDisplay;

                selectedData = [];
                for (let row = startRow; row <= endRow; row++) {
                    for (let col = startCol; col <= endCol; col++) {
                        selectedData.push(hot.getDataAtCell(row, col));
                    }
                }
                console.log("Selected data:", selectedData);
            });
        }
    });
</script>
{% endblock %}
