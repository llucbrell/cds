{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-12 text-center my-4">
            <h1>Visor de CSV</h1>
        </div>
        <div class="col-md-12">
            <form id="csv-form" enctype="multipart/form-data">
                <div class="form-group">
                    <input type="file" id="csv-file" name="csv_file" class="form-control" accept=".csv,.xlsx" required>
                </div>
                <button type="submit" class="btn btn-primary mt-2">Cargar CSV</button>
            </form>
            <div id="csv-output" class="mt-3"></div>
            <div id="csv-table" class="mt-3" style="width: 100%; height: 600px; overflow: auto;"></div>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-md-12">
            <h4 style="margin-top: 50px;">Seleccionar Rango</h4>
            <form id="range-form">
                <div class="form-group">
                    <label for="range-start">Inicio:</label>
                    <input type="text" id="range-start" name="range_start" class="form-control" placeholder="Ej: A1">
                </div>
                <div class="form-group">
                    <label for="range-end">Fin:</label>
                    <input type="text" id="range-end" name="range_end" class="form-control" placeholder="Ej: C10">
                </div>
                <button type="submit" class="btn btn-primary mt-2">Actualizar Rango</button>
            </form>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const container = document.getElementById('csv-table');
        let hot;

        document.getElementById('csv-form').addEventListener('submit', function (event) {
            event.preventDefault();
            const fileInput = document.getElementById('csv-file');
            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function (event) {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const csvData = XLSX.utils.sheet_to_csv(worksheet);
                displayTable(csvData);
            };

            reader.readAsArrayBuffer(file);
        });

        document.getElementById('range-form').addEventListener('submit', function (event) {
            event.preventDefault();
            const rangeStart = document.getElementById('range-start').value;
            const rangeEnd = document.getElementById('range-end').value;

            const startCell = Handsontable.helper.cellReferenceToIndex(rangeStart);
            const endCell = Handsontable.helper.cellReferenceToIndex(rangeEnd);

            const selectedData = [];
            for (let row = startCell.row; row <= endCell.row; row++) {
                const rowData = [];
                for (let col = startCell.col; col <= endCell.col; col++) {
                    rowData.push(hot.getDataAtCell(row, col));
                }
                selectedData.push(rowData);
            }

            displayTable(selectedData.map(row => row.join(',')).join('\n'));
        });

        function displayTable(csvData) {
            const data = csvData.split('\n').map(row => row.split(','));

            if (hot) {
                hot.destroy();
            }

            hot = new Handsontable(container, {
                data: data,
                rowHeaders: true,
                colHeaders: true,
                contextMenu: true,
                filters: true,
                dropdownMenu: true,
                height: 'auto', // Ensures the table adapts to the content
                width: '100%',  // Ensures the table adapts to the container width
                licenseKey: 'non-commercial-and-evaluation'
            });
        }
    });
</script>
{% endblock %}