{% extends 'base.html' %}
{% block content %}

<div class="container">
<div class="row">
<div class="col-md-12">
<a href="{{ url_for('collections') }}" class="btn btn-warning" title="Back to Collection's list" style="float: right;"><i class="fas fa-arrow-left"></i></a>
    </div>
    </div>
<div class="row align-items-center">
        <div class="col-md-12 text-center">
            <img src="{{ url_for('static', filename='images/surf_group_wax.png') }}" alt="Collections icon" class="img-fluid" style="max-width: 10%;">
        </div>
</div>
<h1>Edit Collection</h1>
<form method="POST">
    <div class="form-group">
        <label for="name">Collection Name</label>
        <input type="text" class="form-control" id="name" name="name" value="{{ collection.name }}" required>
    </div>
    <button type="submit" class="btn btn-primary">Update Collection</button>
</form>
     <div class="row">
        <div class="col-md-12 text-center my-4">
            <h1>Datos Generales</h1>
        </div> 
    </div>
    <div class="row">
        <div class="col-md-4">
            <h3>Auth URL</h3>
    <div class="d-flex align-items-center">
        <input id="auth-url-input" placeholder="http://example.com/api/v1/auth" value="{{ auth_url or '' }}" type="text" class="form-control">
        <button id="save-auth-url-button" class="btn btn-outline-primary" title="Save to DB" style="margin-left: 3px;"><i class="fas fa-save"></i></button>
    </div>
    <div id="save-auth-url-output" class="mt-2"></div>
    </div>
        <div class="col-md-4">
            <h3>API Key</h3>
        <div class="d-flex align-items-center">
            <input id="api-key-input" placeholder="Your API Key" value="{{ api_key or '' }}" type="text" class="form-control">
            <button id="save-api-key-button" class="btn btn-outline-primary" style="margin-left: 3px;" title="Save to DB"><i class="fas fa-save"></i></button>
        </div>
            <div id="save-api-key-output" class="mt-2"></div>
        </div>
        <div class="col-md-4">
            <h3>Destination URL</h3>
        <div class="d-flex align-items-center">
            <input id="my-input" placeholder="http://example.com" value="{{ target_url or '' }}" type="text" class="form-control">
            <button id="save-target-url-button" class="btn btn-outline-primary" style="margin-left: 3px;" title="Save to DB"><i class="fas fa-save"></i></button>
        </div>
            <div id="save-target-url-output" class="mt-2"></div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <h3>Plantilla de Request</h3>
            <textarea id="template-request" placeholder="Escribe la plantilla de request como objeto json, sustitución dinámica de {{'{{url}}'}}, {{'{{payload}}'}}, {{'{{api_key}}'}} y {{'{{prompt}}'}} por sus respectivos valores." class="form-control" style="width: 100%; height: 200px;">{{ template_request or '' }}</textarea>
            <button id="upload-request-template" class="btn btn-outline-secondary mt-2" title="Upload from file"><i class="fas fa-file-upload"></i></button>
            <button id="download-request-template" class="btn btn-outline-secondary mt-2" title="Save to File"><i class="fas fa-file-download"></i></button>
            <button id="save-request-template" class="btn btn-outline-primary mt-2" title="Save to DB" ><i class="fas fa-save"></i></button>
            <div id="template-request-output" class="mt-3"></div>
        </div>
    </div>


    <div class="row">
    <div class="col-md-12">
        <a href="{{ url_for('collections') }}" class="btn btn-warning" title="Back to Collection's list" style="float: right;"><i class="fas fa-arrow-left"></i></a>
    </div>
    </div>
    </div>

<script>

    document.addEventListener('DOMContentLoaded', function () {
        function getIdsFromUrl() {
            const pathArray = window.location.pathname.split('/');
            const collectionId = pathArray[pathArray.length - 1];
            return { collectionId };
        }

        const { collectionId } = getIdsFromUrl();
        console.log(`collectionId: ${collectionId}`);  // Logging IDs

        function saveData(endpoint, data, outputId) {
            console.log(`Sending data to ${endpoint}:`, data);  // Logging request data
            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                console.log(`Response from ${endpoint}:`, data);  // Logging response data
                document.getElementById(outputId).innerText = data.message;
                document.getElementById(outputId).className = data.status === 'success' ? 'text-success' : 'text-danger';
                setTimeout(() => {
                    document.getElementById(outputId).innerText = '';
                    document.getElementById(outputId).className = '';
                }, 5000);  // Clear message after 5 seconds
            })
            .catch(error => console.error('Error:', error));  // Logging errors
        }

        document.getElementById('save-auth-url-button').addEventListener('click', function () {
            const authUrl = document.getElementById('auth-url-input').value;
            const endpoint = `/tests/config/${testId}/${collectionId}`;
            saveData(endpoint, { 'auth-url-input': authUrl }, 'save-auth-url-output');
        });

        document.getElementById('save-api-key-button').addEventListener('click', function () {
            const apiKey = document.getElementById('api-key-input').value;
            const endpoint = `/tests/config/${testId}/${collectionId}`;
            saveData(endpoint, { 'api-key-input': apiKey }, 'save-api-key-output');
        });

        document.getElementById('save-target-url-button').addEventListener('click', function () {
            const targetUrl = document.getElementById('my-input').value;
            const endpoint = `/tests/config/${testId}/${collectionId}`;
            saveData(endpoint, { 'my-input': targetUrl }, 'save-target-url-output');
        });

});
</script>
{% endblock %}
